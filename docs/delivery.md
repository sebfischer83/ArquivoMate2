# Delivery (Streaming) How-to

## Summary
ArquivoMate2 streams document artifacts directly from storage to HTTP responses to minimise memory usage, support on-the-fly decryption, and preserve backpressure. This guide complements `docs/ProjectOverview.md` with implementation patterns for controllers, storage providers, and clients.

## Current Status
Streaming delivery is in production. `IDocumentArtifactStreamer` coordinates decryption and metadata resolution, while delivery providers choose between presigned URLs, CDN links, or server-routed downloads. SSE-C-enabled artifacts automatically fall back to server streaming.

## Key Components
- **`IStorageProvider.StreamFileAsync(fullPath, streamConsumer, ct)`** – Storage adapters call `streamConsumer` with a streaming source and must honour cancellation without buffering entire files.
- **`IDocumentArtifactStreamer`** – Returns a `(WriteToAsync, ContentType)` tuple that controllers use to write artifact bytes into any destination stream.
- **`PushStreamResult`** – An ASP.NET Core helper that invokes the streaming delegate with `Response.Body` while respecting pipeline lifetime events.
- **`IDeliveryProvider` implementations** – Decide whether clients receive presigned URLs (`S3DeliveryProvider`, `BunnyCdnDeliveryProvider`), direct storage paths (`NoopDeliveryProvider`), or server URLs (`ServerDeliveryProvider`).

## Process Flow
1. Controller validates a short-lived access token via `IFileAccessTokenService`.
2. `DocumentView` is loaded to confirm state and permissions.
3. `IDocumentArtifactStreamer.GetAsync` returns the streaming delegate and content type.
4. Controller sets cache headers and returns `PushStreamResult` (or writes manually to `Response.Body`).

## Configuration Notes
- `ServerDeliveryProvider` issues URLs like `/api/delivery/{documentId}/{artifact}?token=...` and requires `App:PublicBaseUrl` when absolute URLs are needed.
- Token lifetimes reuse `Encryption:TokenTtlMinutes`.
- Selecting `ServerDeliveryProvider` globally can be done by swapping the DI registration for `IDeliveryProvider`; alternatively extend `DeliveryProviderType` to make the choice configurable.

## Storage Provider Guidance
- Prefer zero-copy streaming APIs from your storage SDK (e.g., MinIO `GetObjectAsync` with `WithCallbackStream`).
- Handle non-seekable streams and propagate cancellation. Avoid buffering into `MemoryStream` except when encryption format requires trailing-tag access.

## Encryption Behaviour
- `DocumentArtifactStreamer` supports AES-GCM (version 1) and AES-CBC + HMAC (version 2).
- Version 2 decrypts and validates incrementally; version 1 may need a small buffer for the trailing tag. Optimise using ring buffers if necessary.
- SSE-C artifacts emit `sse-c://` marker URLs from `S3DeliveryProvider`; the server intercepts and streams them so encryption keys remain server-side.

## Client Examples
- **cURL**
  ```bash
  curl -L "https://api.example.com/api/delivery/{documentId}/file?token={token}" -o document.pdf
  ```
- **Browser Fetch**
  ```js
  fetch('/api/delivery/{id}/file?token={token}')
    .then(res => res.blob())
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'document.pdf';
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
    });
  ```

## Testing Checklist
- Unit-test `IDocumentArtifactStreamer` consumers by injecting `MemoryStream` payloads (see `tests/ArquivoMate2.Infrastructure.Tests/DocumentArtifactStreamerTests.cs`).
- Run integration tests against MinIO/S3 to verify streaming behaviour, cancellation, and large-file handling.
- Confirm SSE-C artifacts route through server streaming and fail when accessed directly without headers.

## Security Considerations
- Delivery tokens remain short lived and are generated by `IFileAccessTokenService`.
- Master keys for client-side decryption should stay in managed secret stores.
- When decryption fails, return a generic `404` to avoid leaking existence details.

## References
- `src/ArquivoMate2.API/Controllers/DeliveryController.cs`
- `src/ArquivoMate2.Infrastructure/Services/DeliveryProvider`
- `src/ArquivoMate2.Infrastructure/Services/DocumentArtifactStreamer.cs`
- `docs/SSE-C-Implementation.md`

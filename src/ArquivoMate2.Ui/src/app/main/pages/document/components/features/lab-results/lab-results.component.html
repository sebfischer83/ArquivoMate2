<ng-container *transloco="let t">
  <div class="lab-results-root">
    <div class="lab-placeholder">
      @if (statusLoadingSignal() || dataLoadingSignal()) { <div class="lab-loading">
        <p>{{ t('Document.LoadingLabResults') || 'Lade Laborwerte...' }}</p>
      </div> }

      @if (statusErrorSignal() || dataErrorSignal()) { <div class="lab-error" tuiSurface appearance="negative">
        <p>{{ statusErrorSignal() || dataErrorSignal() }}</p>
        @if (document?.id) { <div class="lab-error-actions">
          <button tuiButton appearance="primary" size="s" iconStart="@tui.refresh-ccw" type="button" (click)="restartProcessing(document?.id)">{{ t('Document.LabResults.Restart') || 'Verarbeitung erneut starten' }}</button>
        </div> }
      </div> }

      @if (status?.data?.state === 'Running') { <div class="lab-status" tuiSurface>
        <p>{{ (t('Document.LabResults.Processing') || 'Laborwerte werden verarbeitet') }}</p>
      </div> }


  @if (!(statusLoadingSignal() || dataLoadingSignal()) && !(statusErrorSignal() || dataErrorSignal())) { <div>
        @if ((labResults?.data?.length || 0) > 0) { <div class="lab-results-list">
            @for (result of labResults?.data || []; track result.id) { <div class="lab-result">
              <div class="lab-result-header">
                <h4>{{ result.date | localeDate:'shortDate' }}</h4>
                @if (editMode) { <button tuiButton appearance="flat" size="s" iconStart="@tui.trash" type="button" (click)="removeResult(result.id)"></button> }
                
              </div>
              <div class="lab-table-wrapper">
                <table class="lab-table">
                <thead>
                  <tr>
                    <th>{{ t('Document.LabResults.Parameter') }}</th>
                    <th>{{ t('Document.LabResults.Value') }}</th>
                    <th>{{ t('Document.LabResults.Unit') || 'Einheit' }}</th>
                    <th>{{ t('Document.LabResults.ReferenceRange') }}</th>
                  </tr>
                </thead>
                  <tbody>
                  @for (point of result.points || []; track $index) { <tr [class.abnormal]="isPointAbnormal(point)">
                    <td class="param">
                      <tui-input-inline>
                        <input type="text" [formControl]="controlForField(result.id, $index, 'parameter', point?.parameter)" />
                      </tui-input-inline>
                    </td>
                    <td class="value" [tuiHint]="(t('Document.LabResults.Hint.Raw') || 'Roh: ') + (point?.resultRaw || '-') + ' ' + (point?.unit || '') + '\n' + (t('Document.LabResults.Hint.Normalized') || 'Normalisiert: ') + (point?.normalizedResult != null ? point?.normalizedResult : '-') + ' ' + (point?.normalizedUnit || '') + (point?.reference ? ('\n' + (t('Document.LabResults.ReferencePrefix') || 'Ref: ') + point?.reference) : '')">
                      <tui-input-inline>
                        @if (point?.resultComparator != null) { {{ point.resultComparator }} }
                        <input type="number" [formControl]="controlForPoint(result.id, $index, point?.normalizedResult)" class="lab-input-numeric" />
                      </tui-input-inline>
                    </td>
                    <td class="unit">
                      <tui-input-inline>
                        <input type="text" [formControl]="controlForField(result.id, $index, 'unit', point?.unit)" class="lab-input-unit" />
                      </tui-input-inline>
                    </td>
                    <td class="ref">
                      <span class="ref-text">{{ formatReference(point) }}</span>
                    </td>
                    </tr> }
                </tbody>
              </table>
              </div>
            </div> }
          </div> }

        @if (status?.data?.completedAtUtc != null && !((labResults?.data?.length || 0) > 0)) { <p>{{ t('Document.LabResults.Empty') || 'Keine Laborwerte vorhanden.' }}</p> }
      </div> }
    </div>
  </div>
</ng-container>

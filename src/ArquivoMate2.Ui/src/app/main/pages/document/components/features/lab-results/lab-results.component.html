<ng-container *transloco="let t">
  <div class="lab-results-root">
    <h3>{{ t('Document.Tabs.LabResults') }}</h3>
    <div class="lab-placeholder">
      @if (statusLoading || dataLoading) { <div class="lab-loading">
        <p>{{ t('Document.LoadingLabResults') || 'Lade Laborwerte...' }}</p>
      </div> }

      @if (statusError || dataError) { <div class="lab-error" tuiSurface appearance="negative">
        <p>{{ statusError || dataError }}</p>
      </div> }

      @if (status?.data?.completedAtUtc == null) { <div class="lab-status" tuiSurface>
        <p>{{ (t('Document.LabResults.Processing') || 'Laborwerte werden verarbeitet') + ' â€” ' + (getStateLabel(status?.data?.state) || '') + ' (' + (status?.data?.attemptCount || 0) + ')' }}</p>
        <button tuiButton size="s" appearance="flat" type="button" (click)="refreshStatus()">{{ t('Document.Refresh') || 'Aktualisieren' }}</button>
      </div> }

      @if (!(statusLoading || dataLoading) && !(statusError || dataError)) { <div>
        @if ((labResults?.data?.length || 0) > 0) { <div class="lab-results-list">
            @for (result of labResults?.data || []; track result.id) { <div class="lab-result">
              <h4>{{ result.date }} <span class="muted">{{ result.labName }}</span></h4>
              <div class="lab-table-wrapper">
                <table class="lab-table">
                <thead>
                  <tr>
                    <th>{{ t('Document.LabResults.Table.Parameter') }}</th>
                    <th>{{ t('Document.LabResults.Table.Value') }}</th>
                    <th>{{ t('Document.LabResults.Table.ReferenceRange') }}</th>
                  </tr>
                </thead>
                  <tbody>
                  @for (point of result.points || []; track $index) { <tr [class.abnormal]="isPointAbnormal(point)">
                    <td class="param">
                      {{ point.parameter }}
                    </td>
                    <td class="value" [tuiHint]="(t('Document.LabResults.Hint.Raw') || 'Roh: ') + (point?.resultRaw || '-') + ' ' + (point?.unit || '') + '\n' + (t('Document.LabResults.Hint.Normalized') || 'Normalisiert: ') + (point?.normalizedResult != null ? point?.normalizedResult : '-') + ' ' + (point?.normalizedUnit || '') + (point?.reference ? ('\n' + (t('Document.LabResults.ReferencePrefix') || 'Ref: ') + point?.reference) : '')">
                      @if (point?.resultComparator != null) { {{ point.resultComparator }} }
                      {{ point?.normalizedResult }} {{ point?.normalizedUnit }}
                    </td>
                    <td class="ref">
                      <span>{{ formatReference(point) }}</span>
                    </td>
                    </tr> }
                </tbody>
              </table>
              </div>
            </div> }
          </div> }

        @if (!((labResults?.data?.length || 0) > 0)) { <p>{{ t('Document.LabResults.Empty') || 'Keine Laborwerte vorhanden.' }}</p> }
      </div> }

  @if (document) { <p>{{ document && document.id ? ((t('Document.IdLabel') || 'ID: ') + document.id) : '' }}</p> }
    </div>
  </div>
</ng-container>

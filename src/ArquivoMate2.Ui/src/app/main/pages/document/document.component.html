<ng-container *transloco="let t">
<div class="document-layout page-flex-root">
	<div class="main-area" tuiSurface appearance="floating">
		<div class="document-detail">
			<div class="toolbar-wrapper">
				<div class="toolbar">
					<div class="left">
						<button tuiButton size="s" appearance="secondary" iconStart="@tui.arrow-left" type="button" (click)="back()">{{ t('Document.Back') || '←' }}</button>
						<div class="nav-buttons" *ngIf="hasData()">
							<button
								tuiButton
								size="s"
								appearance="secondary"
								iconStart="@tui.chevron-left"
								type="button"
								(click)="goToPrevious()"
								[disabled]="!hasNavigationContext() || !canNavigatePrevious() || navigationBusy()"
							>
								{{ t('Document.PreviousDocument') }}
							</button>
							<button
								tuiButton
								size="s"
								appearance="secondary"
								iconStart="@tui.chevron-right"
								type="button"
								(click)="goToNext()"
								[disabled]="!hasNavigationContext() || !canNavigateNext() || navigationBusy()"
							>
								{{ t('Document.NextDocument') }}
							</button>
							<!-- Accept button: shown when document is not accepted -->
							<button
								*ngIf="!document()?.accepted"
								tuiButton
								size="s"
								appearance="primary"
								iconStart="@tui.check"
								type="button"
								(click)="confirmAccept()"
								[disabled]="acceptPending() || loading()"
							>
								{{ t('Document.Accept') || 'Accept' }}
							</button>
						</div>
					</div>
					<div class="actions" *ngIf="hasData()">
						<div class="global-edit">
							<button
								tuiButton
								size="s"
								appearance="secondary"
								iconStart="@tui.pen"
								type="button"
								*ngIf="!editMode() && hasData()"
								(click)="startEdit()"
								[attr.title]="t('Document.Edit')"
								[attr.aria-label]="t('Document.Edit')"
							></button>
							<button
								tuiButton
								size="s"
								appearance="primary"
								iconStart="@tui.check"
								type="button"
								*ngIf="editMode()"
								(click)="saveEdit()"
								[attr.title]="t('Document.Save')"
								[attr.aria-label]="t('Document.Save')"
							></button>
							<button
								tuiButton
								size="s"
								appearance="flat"
								iconStart="@tui.undo"
								type="button"
								*ngIf="editMode()"
								(click)="cancelEdit()"
								[attr.title]="t('Document.Cancel')"
								[attr.aria-label]="t('Document.Cancel')"
							></button>
						</div>
						<!-- If archivePath exists show dropdown menu, else show direct download button -->
						<ng-container *ngIf="document()?.archivePath; else noArchive">
							<button
								size="s"
								appearance="flat"
								tuiButton
								iconStart="@tui.download"
								type="button"
								[tuiDropdownOpen]="downloadMenuOpen()"
								(tuiDropdownOpenChange)="onDownloadMenu($event)"
								[tuiDropdown]="downloadMenu"
								[disabled]="!filePath || downloadLoading()"
							>
								{{ downloadLoading() ? t('Document.LoadingEllipsis') : t('Document.Download') }}
							</button>
							<ng-template #downloadMenu>
								<div class="download-menu" tuiDropdown tuiSurface appearance="floating">
									<button type="button" tuiButton size="s" appearance="flat" class="menu-item" (click)="downloadOriginal(); closeDownloadMenu()" [disabled]="downloadLoading()">{{ t('Document.DownloadOriginal') }}</button>
									<button type="button" tuiButton size="s" appearance="flat" class="menu-item" (click)="downloadArchive(); closeDownloadMenu()" [disabled]="downloadLoading()">{{ t('Document.DownloadArchive') }}</button>
								</div>
							</ng-template>
						</ng-container>
						<ng-template #noArchive>
							<button tuiButton size="s" appearance="flat" iconStart="@tui.download" type="button" (click)="downloadOriginal()" [disabled]="!filePath || downloadLoading()">{{ downloadLoading() ? t('Document.LoadingEllipsis') : t('Document.Download') }}</button>
						</ng-template>
						<button tuiButton size="s" appearance="flat" iconStart="@tui.external-link" type="button" (click)="openInNewTab()" [disabled]="!filePath">{{ t('Document.Open') }}</button>
					</div>
				</div>
			</div>

			<ng-container *ngIf="loading()">
				<section class="skeleton" [attr.aria-label]="t('Document.LoadingDocument')">
					<div class="sk-line w-30"></div>
					<div class="sk-line w-55"></div>
					<div class="sk-line w-40"></div>
					<div class="sk-line w-65"></div>
					<div class="sk-line w-25"></div>
				</section>
			</ng-container>
			<ng-container *ngIf="error()">
				<div class="error" tuiSurface appearance="negative">
					<p>{{ error() }}</p>
					<button tuiButton appearance="primary" size="s" iconStart="@tui.refresh-ccw" type="button" (click)="retry()">{{ t('Document.Retry') }}</button>
				</div>
			</ng-container>
			<ng-container *ngIf="hasData() && document() as doc">
				
				<div class="doc-split"> 
					<div class="detail-pane left-col">
														<app-document-tabs [(activeIndex)]="activeItemIndex" [sticky]="true" [notesCount]="document()?.notesCount || 0"></app-document-tabs>
								<div class="title-row">
									<h2 tuiTitle="m" class="doc-title">{{ document()?.title || originalFileName() || t('Document.DocumentTitleFallback') }}</h2>
								</div>
						<ng-container *ngIf="activeItemIndex === 1">
							<app-content-toolbar class="outside-content-toolbar" [wrap]="wrapContent" [copied]="copiedContent" (toggleWrap)="toggleWrap()" (copy)="copyContent()" />
						</ng-container>
				            <div class="left-scroll">

						<div class="tab-content">
						<section class="tab-pane properties" [class.active]="activeItemIndex === 0">
							<div *ngIf="doc.summary" class="summary-box details-summary">
								<div class="summary-label">{{ t('Document.Summary') }}</div>
								<div class="summary-text">{{ doc.summary }}</div>
							</div>
							<div class="keywords-box">
								<div class="keywords-header">
									<span class="keywords-label">{{ t('Document.Keywords') }}</span>
								</div>
								<div class="keywords-chips">
									<ng-container *ngFor="let k of keywords(); trackBy: trackByKeyword">
										<span tuiChip size="s" appearance="primary" class="keyword-chip" [class.added]="lastAddedKeyword() === k" [class.removing]="removalSet().has(k)" title="Keyword">{{ k }}
											<button type="button" class="chip-remove" aria-label="Keyword entfernen" (click)="$event.stopPropagation(); removeKeyword(k)" [disabled]="removalSet().has(k) || keywordPendingSet().has(k)">
												<ng-container *ngIf="keywordPendingSet().has(k); else cross">
													<svg width="12" height="12" viewBox="0 0 50 50" class="chip-spinner" aria-hidden="true">
														<circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.4 31.4" transform="rotate(-90 25 25)"></circle>
													</svg>
												</ng-container>
												<ng-template #cross>&times;</ng-template>
										</button>
										</span>
									</ng-container>
									<ng-container *ngIf="!keywords().length">
										<span class="keywords-empty">{{ t('Document.NoKeywords') }}</span>
									</ng-container>
								</div>
								<div class="keywords-add-row">
									<input type="text" class="keyword-input" [value]="newKeyword()" (input)="onKeywordInput($any($event.target).value)" (keydown)="onKeywordKey($event)" [placeholder]="t('Document.NewKeyword')" />
									<button tuiButton size="xs" appearance="flat" type="button" (click)="addKeyword()" [disabled]="!newKeyword().trim() || keywordAddPending()">{{ keywordAddPending() ? t('Document.LoadingEllipsis') : t('Document.Add') }}</button>
								</div>
							</div>
							<div class="prop-grid">
								<div class="prop"><span class="label">{{ t('Document.FileName') }}</span><span class="value mono">{{ originalFileName() || '-' }}</span></div>
								<div class="prop"><span class="label">ID</span><span class="value mono" title="Doppelklick zum Kopieren" (dblclick)="copyId()">{{ doc.id }}</span></div>
								<div class="prop"><span class="label">{{ t('Document.Title') }}</span>
									<span class="value" *ngIf="!editMode()">{{ doc.title }}</span>
									<span class="value" *ngIf="editMode()">
										<input tuiInput type="text" [value]="editBuffer().title" (input)="setEditTitle($any($event.target).value)" />
									</span>
								</div>
								<div class="prop"><span class="label">{{ t('Document.Type') }}</span>
									<span class="value" *ngIf="!editMode()">{{ doc.type || '-' }}</span>
																		<span class="value" *ngIf="editMode()">
																			<input
																				tuiInput
																				type="text"
																				[value]="editBuffer().type || ''"
																				(input)="setEditType($any($event.target).value)"
																				list="documentTypesList"
																				[placeholder]="t('Document.SelectType') || 'Type wählen'"
																			/>
																			<datalist id="documentTypesList">
																				<ng-container *ngFor="let n of documentTypeNames()">
																					<option [value]="n"></option>
																				</ng-container>
																			</datalist>
																		</span>
																		</div>
																		<div class="prop"><span class="label">{{ t('Document.Accepted') }}</span><span class="value">{{ doc.accepted ? t('Document.Yes') : t('Document.No') }}</span></div>
								<div class="prop"><span class="label">{{ t('Document.UploadedAt') }}</span><span class="value">{{ doc.uploadedAt || '-' }}</span></div>
								<div class="prop" *ngIf="doc.contentLength"><span class="label">{{ t('Document.ContentLength') }}</span><span class="value mono">{{ doc.contentLength }}</span></div>
								<div class="prop" *ngIf="doc.invoiceNumber"><span class="label">{{ t('Document.InvoiceNumber') }}</span><span class="value mono">{{ doc.invoiceNumber }}</span></div>
								<div class="prop" *ngIf="doc.customerNumber"><span class="label">{{ t('Document.CustomerNumber') }}</span><span class="value mono">{{ doc.customerNumber }}</span></div>
							</div>
						</section>
						<section class="tab-pane content-view" [class.active]="activeItemIndex === 1">
							<div class="content-box" [class.nowrap]="!wrapContent()" tuiScrollbar>
								<pre class="doc-content" [class.nowrap]="!wrapContent()">{{ doc.content }}</pre>
							</div>
						</section>
						<section class="tab-pane history-view" [class.active]="activeItemIndex === 2">
							<app-document-history style="width: 100%;" [events]="history()"></app-document-history>
						</section>
						<section class="tab-pane notes-view" [class.active]="activeItemIndex === 3">
							<app-notes-list
								[notes]="notes()"
								[loading]="notesLoading()"
								[error]="notesError()"
								[adding]="addingNote()"
								(retry)="retryNotes()"
								(add)="addNote($event)"
							></app-notes-list>
						</section>
						</div><!-- /.tab-content -->
						</div><!-- /.left-scroll -->
					</div><!-- /.detail-pane -->
											<div class="preview-pane right-col">
															<div class="preview-header">
																<h3 tuiTitle="s">{{ t('Document.Preview') }}</h3>
															</div>
															<ng-container *ngIf="previewPath; else noPreview">
																<div class="preview-toolbar-wrapper">
																	<app-pdfjs-viewer-toolbar [viewer]="pdfViewer" class="pdf-toolbar-sticky"></app-pdfjs-viewer-toolbar>
																</div>
																<div class="preview-frame">
																	<app-pdfjs-viewer #pdfViewer [initialFitMode]="'width'" [src]="previewPath"></app-pdfjs-viewer>
																</div>
															</ng-container>
															<ng-template #noPreview>
																<div class="no-preview" tuiSurface appearance="floating">{{ t('Document.NoPreview') }}</div>
															</ng-template>
											</div>
					</div><!-- /.doc-split -->
			</ng-container>
		</div>
	</div>
</div>
</ng-container>

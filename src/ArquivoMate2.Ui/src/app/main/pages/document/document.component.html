<ng-container *transloco="let t">
<div class="document-layout page-flex-root">
	<div class="main-area" tuiSurface appearance="floating">
		<div class="document-detail">
			<div class="toolbar">
				<div class="left">
					<button tuiButton size="s" appearance="secondary" iconStart="@tui.arrow-left" type="button" (click)="back()">{{ t('Document.Back') || '‚Üê' }}</button>
					<h2 tuiTitle="m" class="doc-title">{{ document()?.title || originalFileName() || t('Document.DocumentTitleFallback') }}</h2>
				</div>
				<div class="actions" *ngIf="hasData()">
					<!-- If archivePath exists show dropdown menu, else show direct download button -->
					@if (document()?.archivePath) {
						<button
								size="s"
								appearance="flat"
								tuiButton
								iconStart="@tui.download"
								type="button"
								[tuiDropdownOpen]="downloadMenuOpen()"
								(tuiDropdownOpenChange)="onDownloadMenu($event)"
								[tuiDropdown]="downloadMenu"
								[disabled]="!filePath || downloadLoading()"
						>
							{{ downloadLoading() ? t('Document.LoadingEllipsis') : t('Document.Download') }}
						</button>
						<ng-template #downloadMenu>
							<div class="download-menu" tuiDropdown tuiSurface appearance="floating">
								<button type="button" tuiButton size="s" appearance="flat" class="menu-item" (click)="downloadOriginal(); closeDownloadMenu()" [disabled]="downloadLoading()">{{ t('Document.DownloadOriginal') }}</button>
								<button type="button" tuiButton size="s" appearance="flat" class="menu-item" (click)="downloadArchive(); closeDownloadMenu()" [disabled]="downloadLoading()">{{ t('Document.DownloadArchive') }}</button>
							</div>
						</ng-template>
					} @else {
						<button tuiButton size="s" appearance="flat" iconStart="@tui.download" type="button" (click)="downloadOriginal()" [disabled]="!filePath || downloadLoading()">{{ downloadLoading() ? t('Document.LoadingEllipsis') : t('Document.Download') }}</button>
					}
						<button tuiButton size="s" appearance="flat" iconStart="@tui.external-link" type="button" (click)="openInNewTab()" [disabled]="!filePath">{{ t('Document.Open') }}</button>
				</div>
			</div>

			@if (loading()) {
				<section class="skeleton" [attr.aria-label]="t('Document.LoadingDocument')">
					<div class="sk-line w-30"></div>
					<div class="sk-line w-55"></div>
					<div class="sk-line w-40"></div>
					<div class="sk-line w-65"></div>
					<div class="sk-line w-25"></div>
				</section>
			}
			@if (error()) {
				<div class="error" tuiSurface appearance="negative">
					<p>{{ error() }}</p>
					<button tuiButton appearance="primary" size="s" iconStart="@tui.refresh-ccw" type="button" (click)="retry()">{{ t('Document.Retry') }}</button>
				</div>
			}
			@if (hasData() && document(); as doc) {
				<app-document-tabs [(activeIndex)]="activeItemIndex" [sticky]="true" [notesCount]="document()?.notesCount || 0"></app-document-tabs>
				<div class="doc-split"> 
					<div class="detail-pane left-col">
						<!-- Content toolbar moved outside of scroll container so it does not scroll away -->
						@if (activeItemIndex === 1) {
							<app-content-toolbar class="outside-content-toolbar" [wrap]="wrapContent" [copied]="copiedContent" (toggleWrap)="toggleWrap()" (copy)="copyContent()" />
						}
            <div class="left-scroll">
					<div class="tab-content">
						<section class="tab-pane properties" [class.active]="activeItemIndex === 0">
							<div *ngIf="doc.summary" class="summary-box details-summary">
								<div class="summary-label">{{ t('Document.Summary') }}</div>
								<div class="summary-text">{{ doc.summary }}</div>
							</div>
							<div class="keywords-box">
								<div class="keywords-header">
									<span class="keywords-label">{{ t('Document.Keywords') }}</span>
								</div>
								<div class="keywords-chips">
									@for (k of keywords(); track k) {
										<span tuiChip size="s" appearance="primary" class="keyword-chip" [class.added]="lastAddedKeyword() === k" [class.removing]="removalSet().has(k)" title="Keyword">{{ k }}
											<button type="button" class="chip-remove" aria-label="Keyword entfernen" (click)="$event.stopPropagation(); removeKeyword(k)">&times;</button>
										</span>
									}
									@if (!keywords().length) {
											<span class="keywords-empty">{{ t('Document.NoKeywords') }}</span>
									}
								</div>
								<div class="keywords-add-row">
									<input type="text" class="keyword-input" [value]="newKeyword()" (input)="onKeywordInput($any($event.target).value)" (keydown)="onKeywordKey($event)" [placeholder]="t('Document.NewKeyword')" />
									<button tuiButton size="xs" appearance="flat" type="button" (click)="addKeyword()" [disabled]="!newKeyword().trim()">{{ t('Document.Add') }}</button>
								</div>
							</div>
							<div class="prop-grid">
								<div class="prop"><span class="label">{{ t('Document.FileName') }}</span><span class="value mono">{{ originalFileName() || '-' }}</span></div>
								<div class="prop"><span class="label">ID</span><span class="value mono">{{ doc.id }}</span></div>
								<div class="prop" *ngIf="doc.title"><span class="label">{{ t('Document.Title') }}</span><span class="value">{{ doc.title }}</span></div>
								<div class="prop"><span class="label">{{ t('Document.Type') }}</span><span class="value">{{ doc.type || '-' }}</span></div>
								<div class="prop"><span class="label">{{ t('Document.Accepted') }}</span><span class="value">{{ doc.accepted ? t('Document.Yes') : t('Document.No') }}</span></div>
								<div class="prop"><span class="label">{{ t('Document.UploadedAt') }}</span><span class="value">{{ doc.uploadedAt || '-' }}</span></div>
								<div class="prop" *ngIf="doc.contentLength"><span class="label">{{ t('Document.ContentLength') }}</span><span class="value mono">{{ doc.contentLength }}</span></div>
								<div class="prop" *ngIf="doc.invoiceNumber"><span class="label">{{ t('Document.InvoiceNumber') }}</span><span class="value mono">{{ doc.invoiceNumber }}</span></div>
								<div class="prop" *ngIf="doc.customerNumber"><span class="label">{{ t('Document.CustomerNumber') }}</span><span class="value mono">{{ doc.customerNumber }}</span></div>
							</div>
						</section>
						<section class="tab-pane content-view" [class.active]="activeItemIndex === 1">
							<div class="content-box" [class.nowrap]="!wrapContent()" tuiScrollbar>
								<pre class="doc-content" [class.nowrap]="!wrapContent()">{{ doc.content }}</pre>
							</div>
						</section>
						<section class="tab-pane history-view" [class.active]="activeItemIndex === 2">
							<app-document-history style="width: 100%;" [events]="history()"></app-document-history>
						</section>
						<section class="tab-pane notes-view" [class.active]="activeItemIndex === 3">
							<app-notes-list
								[notes]="notes()"
								[loading]="notesLoading()"
								[error]="notesError()"
								[adding]="addingNote()"
								(retry)="retryNotes()"
								(add)="addNote($event)"
							></app-notes-list>
						</section>
						</div><!-- /.tab-content -->
						</div><!-- /.left-scroll -->
					</div><!-- /.detail-pane -->
											<div class="preview-pane right-col">
															<div class="preview-header">
																<h3 tuiTitle="s">{{ t('Document.Preview') }}</h3>
															</div>
															@if (previewPath) {
																<div class="preview-toolbar-wrapper">
																	<app-pdfjs-viewer-toolbar [viewer]="pdfViewer" class="pdf-toolbar-sticky"></app-pdfjs-viewer-toolbar>
																</div>
																<div class="preview-frame">
																	<app-pdfjs-viewer #pdfViewer [initialFitMode]="'width'" [src]="previewPath"></app-pdfjs-viewer>
																</div>
															} @else {
																<div class="no-preview" tuiSurface appearance="floating">{{ t('Document.NoPreview') }}</div>
															}
											</div>
            </div><!-- /.doc-split -->
			}
		</div>
	</div>
</div>
</ng-container>

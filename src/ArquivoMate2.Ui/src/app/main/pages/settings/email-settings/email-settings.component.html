<ng-container *transloco="let t">
<div class="email-settings compact">
  <div class="settings-layout">
    <div class="left">
      <section class="settings-card">
        <div class="card-header">
          <div>
            <h2>{{ t('Settings.Email.ConnectionTitle') }}</h2>
            <p>{{ t('Settings.Email.ConnectionDescription') }}</p>
          </div>
          <span class="status-pill" [class.active]="hasExistingSettings()">
            {{ hasExistingSettings() ? t('Settings.Email.ConnectionActive') : t('Settings.Email.ConnectionMissing') }}
          </span>
        </div>

        <div class="card-body" [class.loading]="loadingSettings()">
          @if (loadingSettings()) {
            <div class="loading-overlay">Lade aktuelle Einstellungen â€¦</div>
          }
          <form [formGroup]="connectionForm" (ngSubmit)="saveSettings()">
            <div class="form-grid">
              <div class="form-field">
                <label for="providerType">{{ t('Settings.Email.Provider.Label') }}</label>
                <tui-textfield tuiSelect>
                  <select id="providerType" formControlName="providerType">
                    @for (option of providerOptions; track option.value) {
                      <option [ngValue]="option.value">{{ option.label }}</option>
                    }
                  </select>
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="server">{{ t('Settings.Email.Server') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="server" type="text" formControlName="server" autocomplete="off" placeholder="{{ t('Settings.Email.Placeholders.Server') }}" />
                </tui-textfield>
                @if (shouldShowConnectionError('server')) {
                  <span class="error">{{ t('Settings.Email.Errors.ServerRequired') }}</span>
                }
              </div>

              <div class="form-field">
                <label for="port">{{ t('Settings.Email.Port') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="port" type="number" min="1" max="65535" formControlName="port" />
                </tui-textfield>
                @if (shouldShowConnectionError('port')) {
                  <span class="error">{{ t('Settings.Email.Errors.PortInvalid') }}</span>
                }
              </div>

              <div class="form-field">
                <label for="username">{{ t('Settings.Email.Username') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="username" type="text" formControlName="username" autocomplete="username" />
                </tui-textfield>
                @if (shouldShowConnectionError('username')) {
                  <span class="error">{{ t('Settings.Email.Errors.UsernameRequired') }}</span>
                }
              </div>

              <div class="form-field">
                <label for="password">{{ t('Settings.Email.Password') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="password" [type]="passwordMasked() ? 'text' : 'password'" formControlName="password" autocomplete="current-password" />
                </tui-textfield>
                <small *ngIf="passwordMasked()">{{ t('Settings.Email.PasswordMaskedNotice') }}</small>
                <!-- security note removed per request -->
                @if (shouldShowConnectionError('password')) {
                  <span class="error">{{ t('Settings.Email.Errors.PasswordRequired') }}</span>
                }
              </div>

              <div class="form-field">
                <label for="displayName">{{ t('Settings.Email.DisplayName') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="displayName" type="text" formControlName="displayName" placeholder="{{ t('Settings.Email.Placeholders.DisplayName') }}" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="defaultFolder">{{ t('Settings.Email.DefaultFolder') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="defaultFolder" type="text" formControlName="defaultFolder" placeholder="{{ t('Settings.Email.Placeholders.DefaultFolder') }}" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="connectionTimeout">{{ t('Settings.Email.TimeoutMs') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="connectionTimeout" type="number" min="1000" step="500" formControlName="connectionTimeout" />
                </tui-textfield>
              </div>
            </div>

            <div class="form-checkboxes">
              <label class="checkbox-field">
                <input type="checkbox" formControlName="useSsl" />
                <span>{{ t('Settings.Email.UseSsl') }}</span>
              </label>
              <label class="checkbox-field">
                <input type="checkbox" formControlName="autoReconnect" />
                <span>{{ t('Settings.Email.AutoReconnect') }}</span>
              </label>
            </div>

            <div class="card-actions">
              <button tuiButton size="s" appearance="primary" type="submit" [disabled]="savingSettings() || !hasConnectionChanges()">
                @if (savingSettings()) { {{ t('Common.SavingEllipsis') }} } @else { {{ t('Settings.Email.SaveSettings') }} }
              </button>
              <button tuiButton size="s" appearance="secondary" type="button" (click)="resetConnectionForm()" [disabled]="loadingSettings() || savingSettings()">
                {{ t('Common.Reset') }}
              </button>
              <button tuiButton size="s" appearance="secondary" type="button" class="danger" (click)="deleteSettings()" [disabled]="deletingSettings()">
                @if (deletingSettings()) { {{ t('Common.RemovingEllipsis') }} } @else { {{ t('Settings.Email.DeleteConnection') }} }
              </button>
            </div>
          </form>
        </div>
      </section>
      <section class="settings-card">
        <div class="card-header rules-header" (click)="toggleRules()" role="button" tabindex="0" (keydown.enter)="toggleRules()" (keydown.space)="toggleRules()">
          <div>
            <h3>{{ t('Settings.Email.CriteriaTitle') }}</h3>
            <p>{{ t('Settings.Email.CriteriaDescription') }}</p>
          </div>
          <span class="status-pill" [class.active]="hasCriteria()">
            {{ hasCriteria() ? t('Settings.Email.CriteriaActive') : t('Settings.Email.CriteriaMissing') }}
          </span>
        </div>

  <tui-expand [expanded]="rulesExpanded()" class="card-body" [class.loading]="loadingCriteria()">
          @if (loadingCriteria()) {
            <div class="loading-overlay">{{ t('Settings.Email.LoadingRules') }}</div>
          }
          <form [formGroup]="criteriaForm" (ngSubmit)="saveCriteria()">
            <div class="form-grid two-columns">
              <div class="form-field">
                <label for="criteriaName">{{ t('Settings.Email.Criteria.Name') }}</label>
                <input id="criteriaName" type="text" formControlName="name" placeholder="{{ t('Settings.Email.Placeholders.CriteriaName') }}" />
                @if (shouldShowCriteriaError('name')) {
                  <span class="error">{{ t('Settings.Email.Errors.CriteriaNameRequired') }}</span>
                }
              </div>

              <div class="form-field">
                <label for="criteriaDescription">{{ t('Settings.Email.Criteria.Description') }}</label>
                <tui-textfield>
                  <textarea tuiTextfield id="criteriaDescription" rows="2" formControlName="description" placeholder="{{ t('Settings.Email.Placeholders.CriteriaDescription') }}"></textarea>
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="folderName">{{ t('Settings.Email.Criteria.Folder') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="folderName" type="text" formControlName="folderName" placeholder="{{ t('Settings.Email.Placeholders.DefaultFolder') }}" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="subjectContains">{{ t('Settings.Email.Criteria.SubjectContains') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="subjectContains" type="text" formControlName="subjectContains" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="fromContains">{{ t('Settings.Email.Criteria.FromContains') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="fromContains" type="text" formControlName="fromContains" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="toContains">{{ t('Settings.Email.Criteria.ToContains') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="toContains" type="text" formControlName="toContains" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="dateFrom">{{ t('Settings.Email.Criteria.DateFrom') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="dateFrom" type="date" formControlName="dateFrom" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="dateTo">{{ t('Settings.Email.Criteria.DateTo') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="dateTo" type="date" formControlName="dateTo" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="isRead">{{ t('Settings.Email.Criteria.IsRead') }}</label>
                <tui-textfield tuiSelect>
                  <select id="isRead" formControlName="isRead">
                    @for (option of triStateOptions; track option.value) {
                      <option [ngValue]="option.value">{{ option.label }}</option>
                    }
                  </select>
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="hasAttachments">{{ t('Settings.Email.Criteria.HasAttachments') }}</label>
                <tui-textfield tuiSelect>
                  <select id="hasAttachments" formControlName="hasAttachments">
                    @for (option of triStateOptions; track option.value) {
                      <option [ngValue]="option.value">{{ option.label }}</option>
                    }
                  </select>
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="maxResults">{{ t('Settings.Email.Criteria.MaxResults') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="maxResults" type="number" min="1" formControlName="maxResults" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="maxDaysBack">{{ t('Settings.Email.Criteria.MaxDaysBack') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="maxDaysBack" type="number" min="1" formControlName="maxDaysBack" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="skip">{{ t('Settings.Email.Criteria.Skip') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="skip" type="number" min="0" formControlName="skip" />
                </tui-textfield>
              </div>

              <div class="form-field">
                <label for="sortBy">{{ t('Settings.Email.Criteria.SortBy') }}</label>
                <tui-textfield tuiSelect>
                  <select id="sortBy" formControlName="sortBy">
                    @for (option of sortOptions; track option.value) {
                      <option [ngValue]="option.value">{{ option.label }}</option>
                    }
                  </select>
                </tui-textfield>
              </div>

              <div class="form-field checkbox-inline">
                <label class="checkbox-field">
                  <input type="checkbox" formControlName="sortDescending" />
                  <span>{{ t('Settings.Email.Criteria.SortDescending') }}</span>
                </label>
              </div>

              <div class="form-field">
                <label for="includeFlags">{{ t('Settings.Email.Criteria.IncludeFlags') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="includeFlags" type="text" formControlName="includeFlags" placeholder="{{ t('Settings.Email.Placeholders.IncludeFlags') }}" />
                </tui-textfield>
                <small>{{ t('Settings.Email.Criteria.FlagsNote') }}</small>
              </div>

              <div class="form-field">
                <label for="excludeFlags">{{ t('Settings.Email.Criteria.ExcludeFlags') }}</label>
                <tui-textfield>
                  <input tuiTextfield id="excludeFlags" type="text" formControlName="excludeFlags" placeholder="{{ t('Settings.Email.Placeholders.ExcludeFlags') }}" />
                </tui-textfield>
              </div>
            </div>

            <div class="card-actions">
              <button tuiButton size="s" appearance="primary" type="submit" [disabled]="savingCriteria() || !hasCriteriaChanges()">
                @if (savingCriteria()) { {{ t('Common.SavingEllipsis') }} } @else { {{ t('Settings.Email.CriteriaSave') }} }
              </button>
              <button tuiButton size="s" appearance="secondary" type="button" (click)="resetCriteriaForm()" [disabled]="loadingCriteria() || savingCriteria()">
                {{ t('Common.Reset') }}
              </button>
              <button tuiButton size="s" appearance="secondary" class="danger" type="button" (click)="deleteCriteria()" [disabled]="deletingCriteria()">
                @if (deletingCriteria()) { {{ t('Common.RemovingEllipsis') }} } @else { {{ t('Settings.Email.CriteriaDelete') }} }
              </button>
            </div>
          </form>
        </tui-expand>
      </section>
    </div> <!-- end .left -->

    <div class="right">
      @if (hasExistingSettings()) {
        <section class="settings-card">
              <div class="card-header">
            <div>
              <h3>{{ t('Settings.Email.StatusTitle') }}</h3>
              <p>{{ t('Settings.Email.StatusDescription') }}</p>
            </div>
          </div>
          <div class="card-body status-card">
            <div class="status-item">
              <span class="label">{{ t('Settings.Email.Status.MessagesInMailbox') }}</span>
              <span class="value">
                @if (loadingCount()) {
                  {{ t('Settings.Email.LoadingCount') }}
                } @else if (emailCount() !== null) {
                  {{ emailCount() }}
                } @else {
                  â€“
                }
              </span>
              @if (lastCountRefresh()) {
                <span class="meta">{{ t('Settings.Email.Status.AsOf') }}: {{ lastCountRefresh() | date:'short' }}</span>
              }
            </div>

            <div class="status-buttons">
              <button tuiButton size="s" appearance="secondary" type="button" (click)="refreshEmailCount()" [disabled]="loadingCount()">
                @if (loadingCount()) { {{ t('Settings.Email.RefreshingEllipsis') }} } @else { {{ t('Settings.Email.RefreshCount') }} }
              </button>
              <button tuiButton size="s" appearance="secondary" type="button" (click)="testConnection()" [disabled]="testingConnection()">
                @if (testingConnection()) { {{ t('Settings.Email.TestingEllipsis') }} } @else { {{ t('Settings.Email.TestConnection') }} }
              </button>
            </div>

            @if (connectionStatus()) {
              <div class="connection-feedback" [class.error]="connectionStatus()?.kind === 'error'" [class.success]="connectionStatus()?.kind === 'success'">
                {{ connectionStatus()?.message }}
              </div>
            }
          </div>
        </section>
      }
    </div>
  </div>
</div>
</ng-container>
